<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR scannen</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f0f14;
      color: #fff;
      margin: 0;
      padding: 24px;
      text-align: center;
    }

    button {
      padding: 14px 22px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #fff;
      color: #000;
    }

    #status {
      margin-top: 20px;
      font-size: 16px;
      opacity: 0.9;
    }

    .ok { color: #4ade80; }
    .bad { color: #f87171; }
  </style>
</head>

<body>

  <h1>QR scannen</h1>
  <p>‚è≥ Wacht tot de categorie is gekozen‚Ä¶</p>

  <button id="scanBtn">üì∑ Scan QR-code</button>

  <div id="status">‚Äî</div>

<script>
const EDGE_URL = "https://wjvldevvjjsueunakmcb.supabase.co/functions/v1/spotify-scan";


const statusEl = document.getElementById("status");
const scanBtn  = document.getElementById("scanBtn");

function setStatus(text, cls = "") {
  statusEl.textContent = text;
  statusEl.className = cls;
}

scanBtn.addEventListener("click", async () => {
  try {
    setStatus("üì° Scannen gestart‚Ä¶");

    // 1Ô∏è‚É£ QR scannen (simpele prompt ‚Äî werkt ook mobiel)
    const code = prompt("Plak of scan de QR-code");
    if (!code) return;

    // 2Ô∏è‚É£ Edge Function aanroepen (doet ALLE inserts)
    const res = await fetch(EDGE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": sb.supabaseKey,
        "Authorization": `Bearer ${sb.supabaseKey}`
      },
      body: JSON.stringify({ code })
    });

    if (!res.ok) {
      setStatus("‚ùå Scan mislukt", "bad");
      return;
    }

    // 3Ô∏è‚É£ Laatste scan ophalen
    const { data: scan, error: scanErr } = await sb
      .from("scan_events")
      .select("id")
      .order("created_at", { ascending: false })
      .limit(1)
      .single();

    if (scanErr || !scan) {
      setStatus("‚ùå Geen scan gevonden", "bad");
      return;
    }

    // 4Ô∏è‚É£ Check of admin al een categorie heeft klaargezet
    const { data: state } = await sb
      .from("quiz_state")
      .select("pending_category")
      .eq("id", 1)
      .single();

    if (state?.pending_category) {
      await sb
        .from("quiz_state")
        .update({
          active_scan_event_id: scan.id,
          active_category: state.pending_category,
          pending_category: null,
          show_answer: false
        })
        .eq("id", 1);

      setStatus("‚úÖ Scan gekoppeld ‚Äî vraag verschijnt!", "ok");
    } else {
      setStatus("‚ÑπÔ∏è Scan ok ‚Äî maar nog geen categorie actief");
    }

  } catch (err) {
    console.error(err);
    setStatus("‚ùå Onverwachte fout", "bad");
  }
});
</script>

</body>
</html>
