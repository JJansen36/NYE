<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify Player ‚Äì Test</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0f0f14;
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 520px;
      max-width: 95vw;
      background: #000;
      border-radius: 16px;
      padding: 24px;
      box-sizing: border-box;
    }

    h1 {
      margin-top: 0;
      font-size: 22px;
    }

    button {
      padding: 12px 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      background: #22c55e;
      color: #000;
      margin-bottom: 16px;
    }

    .label {
      font-size: 13px;
      opacity: 0.8;
      margin-top: 12px;
    }

    .linkbox {
      margin-top: 6px;
      background: #111;
      padding: 12px;
      border-radius: 8px;
      word-break: break-all;
      font-size: 14px;
    }

    .linkbox a {
      color: #4ade80;
      text-decoration: none;
    }

    .status {
      margin-top: 14px;
      font-size: 13px;
      opacity: 0.85;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>üéµ Spotify Player ‚Äì Test</h1>

    <button id="openBtn">Scan luisteren</button>

    <div class="label">Laatste gescande link:</div>
    <div class="linkbox" id="linkBox">‚Äî nog niets ‚Äî</div>

    <div class="status" id="status">Wachten op scan‚Ä¶</div>
  </div>

  <script type="module">
    const SUPABASE_URL = "https://wjvleduvvjjseunakmcb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqdmxlZHV2dmpqc2V1bmFrbWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NDU0NzYsImV4cCI6MjA4MjUyMTQ3Nn0.9GzBjksztdM4SFw_BcAVKl3gwEzBN0jqNhztQ9m9uj0";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const CHECK_INTERVAL = 1500;

    let pollTimer = null;
    let lastSeenId = 0;
    let spotifyTab = null;

    const linkBox = document.getElementById("linkBox");
    const statusEl = document.getElementById("status");
    const openBtn = document.getElementById("openBtn");

    async function setBaseline() {
        const { data } = await sb
            .from("scan_events")
            .select("id")
            .order("id", { ascending: false })
            .limit(1)
            .maybeSingle();

        if (data?.id) {
            lastSeenId = data.id;
        }
        }

    async function pollLatestScan() {
  const { data: ev } = await sb
    .from("scan_events")
    .select("id, created_at, code")
    .order("id", { ascending: false })
    .limit(1)
    .maybeSingle();

  if (!ev) return;
  if (ev.id <= lastSeenId) return;
  if (!ev.code) return;

  lastSeenId = ev.id;

  linkBox.innerHTML = `
    <a href="${ev.code}" target="_blank">${ev.code}</a>
  `;
  statusEl.textContent = "Nieuwe scan ontvangen";

  if (spotifyTab && !spotifyTab.closed) {
    spotifyTab.location.href = ev.code;
    spotifyTab.focus();
  }
}


    openBtn.addEventListener("click", async () => {
  spotifyTab = window.open("about:blank", "_blank");
  if (!spotifyTab) {
    statusEl.textContent = "‚ùå Popup geblokkeerd";
    return;
  }

  // üîë alles wat al bestaat is oud
  await setBaseline();

  statusEl.textContent = "Luisteren actief ‚Äì wacht op nieuwe scan";
  pollTimer = setInterval(pollLatestScan, CHECK_INTERVAL);
});

  </script>
</body>
</html>
