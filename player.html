<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Player</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0f0f14;
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .player {
      width: 520px;
      max-width: 95vw;
      background: #000;
      border-radius: 16px;
      padding: 24px;
      box-sizing: border-box;
    }

    h1 {
      margin-top: 0;
    }

    button {
      padding: 14px 22px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    .open { background: #22c55e; color: #000; }
    .closed { background: #ef4444; color: #fff; }

    .linkbox {
      margin-top: 16px;
      background: #111;
      padding: 14px;
      border-radius: 10px;
      word-break: break-all;
      min-height: 48px;
    }

    .linkbox a {
      color: #4ade80;
      text-decoration: none;
      font-weight: 500;
    }

    .status {
      margin-top: 12px;
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>

<body>
<div class="player">
  <h1>üéÆ Game Player</h1>

  <button id="gameBtn">üéÆ Game openen (3 min)</button>

  <div class="linkbox" id="linkBox">
    Nog geen scan ontvangen
  </div>

  <div class="status" id="status"></div>

  <button onclick="revealAnswer()">Toon antwoord</button>
  <button onclick="hideAnswer()">Verberg</button>

</div>

<script type="module">
/* ===========================
   SUPABASE
=========================== */
const SUPABASE_URL = "https://wjvleduvvjjseunakmcb.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqdmxlZHV2dmpqc2V1bmFrbWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NDU0NzYsImV4cCI6MjA4MjUyMTQ3Nn0.9GzBjksztdM4SFw_BcAVKl3gwEzBN0jqNhztQ9m9uj0";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===========================
   REVEAL (HOOFDSCHERM)
=========================== */
window.revealAnswer = async function () {
  const { data, error } = await sb
    .from("scan_events")
    .select("title, artist, year")
    .order("created_at", { ascending: false })
    .limit(1)
    .single();

  if (error || !data) {
    console.error("Geen scan om te tonen", error);
    return;
  }

  await sb
    .from("game_reveal")
    .update({
      title: data.title,
      artist: data.artist,
      year: data.year,
      visible: true,
      updated_at: new Date()
    })
    .eq("id", 1);

  console.log("‚úÖ Antwoord getoond op screen");
};

window.hideAnswer = async function () {
  await sb
    .from("game_reveal")
    .update({ visible: false })
    .eq("id", 1);

  console.log("üôà Antwoord verborgen");
};



/* ===========================
   CONSTANTS
=========================== */
const GAME_TIMEOUT_MS = 3 * 60 * 1000;
const CHECK_INTERVAL = 1200;

/* ===========================
   STATE
=========================== */
let baselineCode = null;  // laatst bekende code op moment van openen

let scanOpen = false;
let pollTimer = null;
let closeTimer = null;
let lastSeenScanId = 0;

/* ===========================
   UI
=========================== */
const btn = document.getElementById("gameBtn");
const linkBox = document.getElementById("linkBox");
const statusEl = document.getElementById("status");

function updateButton() {
  btn.textContent = scanOpen
    ? "‚õî Game sluiten"
    : "üéÆ Game openen (3 min)";
  btn.className = scanOpen ? "closed" : "open";
}

async function getLatestCode() {
  const { data } = await sb
    .from("scan_events")
    .select("code")
    .order("created_at", { ascending: false }) // alleen sorteren
    .limit(1)
    .maybeSingle();

  return data?.code ?? null;
}

/* ===========================
   GAME STATE
=========================== */
async function openGame() {
  scanOpen = true;
  updateButton();
  statusEl.textContent = "Game open ‚Äì wacht op scan‚Ä¶";
  linkBox.textContent = "Nog geen scan ontvangen";

  // scan_open = true
  await sb.from("game_state").update({ scan_open: true }).eq("id", 1);

  // ‚úÖ baseline = huidige laatste code (mag null zijn)
  baselineCode = await getLatestCode();

  pollTimer = setInterval(checkForScan, CHECK_INTERVAL);
  closeTimer = setTimeout(closeGame, GAME_TIMEOUT_MS);
}




async function closeGame() {
  scanOpen = false;
  updateButton();
  statusEl.textContent = "Game gesloten";

  clearInterval(pollTimer);
  clearTimeout(closeTimer);

  await sb.from("game_state").update({
    scan_open: false
  }).eq("id", 1);
}

/* ===========================
   SCAN LOGIC
=========================== */
async function checkForScan() {
  if (!scanOpen) return;

  const latest = await getLatestCode();
  if (!latest) return;

  // ‚ùå nog niets nieuws sinds openen
  if (latest === baselineCode) return;

  // ‚úÖ nieuw nummer sinds openen
  baselineCode = latest;

  linkBox.innerHTML = `
    <a href="${latest}" target="_blank">‚ñ∂Ô∏è ${latest}</a>
  `;
  statusEl.textContent = "Nieuwe scan ontvangen ‚Äì klik om te spelen";

  // game sluiten zodra er een scan is
  closeGame();
}



/* ===========================
   EVENTS
=========================== */
btn.addEventListener("click", () => {
  if (!scanOpen) {
    openGame();
  }
});

/* ===========================
   INIT
=========================== */
updateButton();
statusEl.textContent = "Game gesloten";
</script>
</body>
</html>
